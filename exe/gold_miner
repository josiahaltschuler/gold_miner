#!/usr/bin/env ruby

$LOAD_PATH.unshift("#{__dir__}/../lib")

require "gold_miner"

def debug(msg)
  return if ENV["DEBUG"].nil?

  puts "[DEBUG] #{msg}"
end

channel = ARGV.first || "dev"

t0 = Time.now

GoldMiner
  .mine_in(channel)
  .fmap { |gold_container|
    debug "Found #{gold_container.gold_nuggets.size} messages in #{Time.now - t0} seconds."
    puts GoldMiner.convert_messages_to_blogpost(channel, container)
  }
  .or { |error| abort "[ERROR] #{error}" }

puts
debug "Done in #{Time.now - t0} seconds."
